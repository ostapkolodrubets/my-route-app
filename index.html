<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Route Planner AI - OSM Geocoding</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.5/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<style>
body { font-family: Arial; max-width: 600px; margin: 40px auto; }
input, button { width: 100%; padding: 12px; margin: 8px 0; }

#map-container { margin-top: 20px; }
#map { width: 100%; height: 450px; border-radius: 10px; }

#result {
  background-color: #fdfdfd;
  border-left: 5px solid #4CAF50;
  padding: 20px;
  margin-top: 20px;
  border-radius: 10px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  font-family: 'Arial', sans-serif;
  line-height: 1.6;
  color: #333;
}

#result pre {
  white-space: pre-wrap;
  word-wrap: break-word;
  background: #f5f5f5;
  padding: 15px;
  border-radius: 8px;
  overflow-x: auto;
  margin-top: 10px;
  color: #444;
  font-family: 'Courier New', monospace;
  font-size: 14px;
}
</style>
</head>

<body>

<h2>Route Planner AI</h2>

<input id="start" placeholder="Enter start address" />
<input id="end" placeholder="Enter destination address" />

<button onclick="send()">Send to AI</button>

<div id="map-container">
  <div id="map"></div>
</div>

<div id="result"></div>

<script src="https://unpkg.com/leaflet@1.9.5/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
var map = L.map('map').setView([50.45, 30.523], 6); // центр України
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var control = null;

// Функція геокодування через Nominatim
async function geocode(address) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
    const res = await fetch(url);
    const data = await res.json();
    if(data && data.length > 0) {
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    } else {
        throw new Error("Address not found: " + address);
    }
}

async function send() {
    const start = document.getElementById("start").value.trim();
    const end = document.getElementById("end").value.trim();

    if(!start || !end) {
        alert("Please enter both addresses!");
        return;
    }

    document.getElementById("result").innerText = "Loading route and AI recommendations...";

    try {
        // Геокодуємо обидві адреси
        const startCoords = await geocode(start);
        const endCoords = await geocode(end);

        // Малюємо маршрут на карті
        if(control) map.removeControl(control);
        control = L.Routing.control({
            waypoints: [
                L.latLng(startCoords[0], startCoords[1]),
                L.latLng(endCoords[0], endCoords[1])
            ],
            routeWhileDragging: false,
            show: true
        }).addTo(map);

        control.on('routesfound', e => map.fitBounds(e.routes[0].bounds));

        // Надсилаємо AI текстові адреси для порад
        const payload = { start_address: start, end_address: end };
        const res = await fetch("https://hook.eu2.make.com/y9ianrfc2521t2g4vl44z6vwpscwhq5l", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data;
        try {
            const cleaned = text.replace(/```/g, ''); // видаляємо Markdown
            data = JSON.parse(cleaned);
        } catch(e) {
            document.getElementById("result").innerText = "AI returned invalid response:\n" + text;
            return;
        }

        // Поради AI
        document.getElementById("result").innerHTML = `<pre>${data.advice}</pre>`;

    } catch(err) {
        console.error(err);
        document.getElementById("result").innerText = "Error: " + err;
    }
}
</script>

</body>
</html>
